<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¯æ„›ä¸­è‹±æ‰“å­—éŠæˆ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;800&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --sky-1: #b3e5ff;
      --sky-2: #d5f1ff;
      --candy-1: #ff9ec2;
      --candy-2: #ffd1dc;
      --mint-1: #a8f0d6;
      --mint-2: #bff4e2;
      --lemon: #fff4a3;
      --ink: #374151;
    }

    body { font-family: 'Noto Sans TC', 'Baloo 2', system-ui, -apple-system, sans-serif; touch-action: manipulation; }

    /* èƒŒæ™¯ï¼šæ¼¸å±¤å¤©ç©º + æ¼‚æµ®é›²æœµ */
    .bg-sky {
      background: linear-gradient(180deg, var(--sky-1) 0%, var(--sky-2) 60%, #ffffff 100%);
      position: relative;
      overflow: hidden;
    }
    .float-cloud { position: absolute; opacity: 0.45; filter: blur(0.2px); animation: floatx var(--t, 36s) linear infinite; }
    .float-cloud svg { display: block; }
    @keyframes floatx { from { transform: translateX(-20%); } to { transform: translateX(120%); } }

    /* å¡ç‰‡å®¹å™¨ */
    .card {
      background: linear-gradient(180deg, #ffffffcc 0%, #ffffff 100%);
      backdrop-filter: blur(6px);
      border: 3px solid #ffffff;
      box-shadow: 0 20px 50px rgba(31, 41, 55, 0.15), inset 0 2px 0 rgba(255,255,255,.9);
    }

    /* æ¨™é¡Œå­—é«”æ›´æ´»æ½‘ */
    .title { font-family: 'Baloo 2', 'Noto Sans TC', cursive; letter-spacing: .5px; }

    /* ç•«å¸ƒå¤©ç©ºå¤–è§€ */
    .game-canvas { cursor: text; border: 4px solid #fff; box-shadow: inset 0 8px 24px rgba(30,64,175,.08); border-radius: 18px; }

    /* ç„¦é»è¼¸å…¥æ¡†ç³–æœé‚Š */
    .input-field:focus { outline: none; box-shadow: 0 0 0 4px rgba(255, 158, 194, 0.5), 0 8px 20px rgba(0,0,0,.08); border-color: var(--candy-1); }

    /* Modal èƒŒæ¿ */
    .modal { background-color: rgba(0, 0, 0, 0.55); }

    /* äº’å‹•æŒ‰éˆ•ï¼šæœå‡å½ˆè·³ */
    .btn-candy { background: linear-gradient(180deg, var(--candy-1), var(--candy-2)); color: #fff; box-shadow: 0 10px 20px rgba(255, 158, 194, .35); }
    .btn-candy:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-mint { background: linear-gradient(180deg, #34d399, #6ee7b7); color: #064e3b; box-shadow: 0 10px 20px rgba(110, 231, 183, .35); }
    .btn-mint:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-lemon { background: linear-gradient(180deg, #fde047, #facc15); color: #713f12; }

    .jelly { transition: transform .15s ease; }
    .jelly:active { transform: scale(.98); }

    /* æ§åˆ¶é¢æ¿å¾®èª¿ */
    .control-panel label { display:block; margin-bottom:.5rem; color:#4b5563; }
    .control-panel input[type="range"] { width:100%; }

    /* å¯æ„›å¾½ç« ï¼ˆå³ä¸Šè§’é£„å¸¶ï¼‰ */
    .ribbon { position:absolute; top:12px; right:-40px; background:linear-gradient(135deg, #fecaca, #fde68a); color:#9a3412; padding:6px 60px; font-weight:700; transform:rotate(35deg); box-shadow:0 8px 18px rgba(0,0,0,.12); border:2px dashed rgba(250, 204, 21, .8); }

    /* æ‰‹æ©Ÿå„ªåŒ– */
    @media (max-width: 420px) { .ribbon{ display:none; } }
  </style>
</head>
<body class="bg-sky min-h-screen flex items-center justify-center">
  <!-- æ¼‚æµ®é›²æœµè£é£¾ -->
  <div class="float-cloud" style="left:-10%; top:8%; --t:38s">
    <svg width="180" height="70" viewBox="0 0 180 70" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="40" cy="40" rx="40" ry="28" fill="#fff"/>
      <ellipse cx="90" cy="28" rx="50" ry="28" fill="#fff"/>
      <ellipse cx="135" cy="42" rx="45" ry="26" fill="#fff"/>
    </svg>
  </div>
  <div class="float-cloud" style="left:-20%; bottom:12%; --t:52s">
    <svg width="240" height="90" viewBox="0 0 240 90" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="50" cy="50" rx="50" ry="30" fill="#fff"/>
      <ellipse cx="120" cy="35" rx="65" ry="30" fill="#fff"/>
      <ellipse cx="185" cy="55" rx="55" ry="28" fill="#fff"/>
    </svg>
  </div>

  <div id="game-container" class="w-[min(92vw,980px)] mx-auto card rounded-3xl shadow-2xl p-4 sm:p-6 relative overflow-hidden">
    <span class="ribbon text-sm">Cute âœ¨ Typing Fun</span>
    <h1 class="title text-3xl sm:text-4xl font-extrabold text-center text-rose-600 drop-shadow mb-3">
      ğŸ“ å¯æ„›ä¸­è‹±æ‰“å­—éŠæˆ²
    </h1>
    <p class="text-center text-sm sm:text-base text-slate-700 mb-4">å¯æ„›ç„¡äººæ©Ÿå¸¶è‘—è©èªé£›ä¾†å•¦ï½å¿«ç”¨éµç›¤æŠŠå®ƒå€‘ã€Œå•¾ï½ã€æ‰ï¼(Enter ç™¼å°„â­)</p>

    <!-- éŠæˆ²ç‹€æ…‹é¡¯ç¤º -->
    <div class="flex flex-wrap gap-2 justify-between items-center bg-white/70 border border-white rounded-2xl p-3 sm:p-4 mb-4 text-sm sm:text-base">
      <div class="flex items-center gap-2"><span class="text-pink-500">ğŸ·ï¸</span><strong>ç­‰ç´š</strong>ï¼š<span id="level">1</span></div>
      <div class="flex items-center gap-2"><span class="text-yellow-500">â­</span><strong>åˆ†æ•¸</strong>ï¼š<span id="score">0</span></div>
      <div class="flex items-center gap-2"><span class="text-blue-500">â±ï¸</span><strong>æ™‚é–“</strong>ï¼š<span id="timer">3:00</span></div>
      <div class="flex items-center gap-2"><span class="text-rose-500">ğŸ’¥</span><strong>å¢œæ¯€</strong>ï¼š<span id="crashes">0 / 3</span></div>
      <button id="abort-button" class="ml-auto btn-lemon jelly px-3 py-1.5 rounded-xl text-sm sm:text-base border-2 border-yellow-300">ä¸­æ­¢ä¸¦è¿”å› â¬…ï¸</button>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas" class="w-full h-96 sm:h-[520px] bg-gradient-to-b from-sky-200 via-sky-100 to-white game-canvas"></canvas>

    <!-- è¼¸å…¥å€åŸŸ -->
    <div class="mt-3">
      <input id="text-input" type="text" placeholder="åœ¨é€™è£¡è¼¸å…¥æ–‡å­—ï¼ŒæŒ‰ Enter ç™¼å°„â­" class="w-full p-3 border-2 border-rose-200 rounded-2xl text-center text-xl transition duration-200 input-field bg-white/90" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled />
    </div>

    <!-- é–‹å§‹è¨­å®š Modal -->
    <div id="start-modal" class="absolute inset-0 flex items-center justify-center modal z-10">
      <div class="bg-white rounded-3xl shadow-2xl w-11/12 max-w-md p-6 border-4 border-pink-200">
        <div class="flex items-center justify-center mb-3">
          <div class="w-14 h-14 rounded-full bg-gradient-to-b from-pink-300 to-pink-200 grid place-items-center text-2xl">ğŸ§¸</div>
        </div>
        <h2 class="title text-2xl font-bold text-center text-rose-600 mb-1">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
        <p class="text-slate-600 text-center mb-4">é¸æ“‡éŠæˆ²é›£åº¦èˆ‡æŒ‘æˆ°æ™‚é–“ï¼</p>
        <div class="control-panel text-left mb-5">
          <div>
            <label for="level-select">é—œå¡ä¸»é¡Œï¼š</label>
            <select id="level-select" class="w-full p-3 border-2 border-rose-200 rounded-xl bg-rose-50">
              <option value="1">ç­‰ç´š 1ï¼šä¸­æ–‡å–®å­— ğŸ¡</option>
              <option value="2">ç­‰ç´š 2ï¼šä¸­æ–‡é›™å­— ğŸ¬</option>
              <option value="3">ç­‰ç´š 3ï¼šä¸­æ–‡ä¸‰å­— ğŸ§‹</option>
              <option value="4">ç­‰ç´š 4ï¼šä¸­æ–‡æˆèª ğŸ°</option>
              <option value="5">ç­‰ç´š 5ï¼šè‹±æ–‡å–®å­—æ¯ ğŸª</option>
              <option value="6">ç­‰ç´š 6ï¼šè‹±æ–‡çŸ­è© (3â€“4) ğŸ­</option>
              <option value="7">ç­‰ç´š 7ï¼šè‹±æ–‡ä¸­é•·è© (5â€“7) ğŸ©</option>
              <option value="8">ç­‰ç´š 8ï¼šè‹±æ–‡é•·è© (8+) ğŸ§</option>
              <option value="9">ç­‰ç´š 9ï¼šä¸­è‹±éš¨æ©ŸæŒ‘æˆ° ğŸ²</option>
              <option value="10">ç­‰ç´š 10ï¼šè‡ªè¨‚ç·´ç¿’ âœï¸</option>
            </select>
          </div>
          <div class="mt-4">
            <label for="drone-speed">ç„¡äººæ©Ÿé€Ÿåº¦ (æ…¢ â†’ å¿«)ï¼š<span id="drone-speed-value">0.5</span></label>
            <input id="drone-speed" type="range" min="0.2" max="2" value="0.5" step="0.1" />
          </div>
          <div class="mt-4">
            <label for="spawn-rate">å‡ºç¾é »ç‡ (å°‘ â†’ å¤š)ï¼š<span id="spawn-rate-value">3.0</span>s</label>
            <input id="spawn-rate" type="range" min="1" max="5" value="3" step="0.2" />
          </div>
          <div class="mt-4">
            <label>æŒ‘æˆ°æ™‚é–“ï¼š</label>
            <div class="flex gap-2 flex-wrap">
              <label class="cursor-pointer">
                <input type="radio" name="duration" value="60" class="peer sr-only" />
                <span class="px-3 py-1.5 rounded-xl border-2 border-rose-200 bg-rose-50 text-rose-700 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500">1 åˆ†é˜</span>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="duration" value="120" class="peer sr-only" />
                <span class="px-3 py-1.5 rounded-xl border-2 border-rose-200 bg-rose-50 text-rose-700 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500">2 åˆ†é˜</span>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="duration" value="180" class="peer sr-only" checked />
                <span class="px-3 py-1.5 rounded-xl border-2 border-rose-200 bg-rose-50 text-rose-700 peer-checked:bg-rose-500 peer-checked:text-white peer-checked:border-rose-500">3 åˆ†é˜</span>
              </label>
            </div>
          </div>
        </div>
        <button id="start-button" class="btn-candy jelly w-full font-bold py-3 px-6 rounded-2xl text-xl transition">é–‹å§‹éŠæˆ² âœ¨</button>
      </div>
    </div>

    <!-- éŠæˆ²çµæŸ Modal -->
    <div id="game-over-modal" class="absolute inset-0 items-center justify-center modal hidden z-10">
      <div class="bg-white p-8 rounded-3xl shadow-2xl text-center w-11/12 max-w-md border-4 border-yellow-200">
        <div class="text-5xl mb-2">ğŸ‰</div>
        <h2 class="title text-3xl font-bold mb-2 text-amber-600">éŠæˆ²çµæŸï¼</h2>
        <p class="text-slate-700 mb-2 text-lg">æœ€çµ‚åˆ†æ•¸ï¼š</p>
        <p id="final-score" class="text-6xl font-extrabold mb-6 text-rose-500 drop-shadow">0</p>
        <button id="restart-button" class="btn-mint jelly w-full font-bold py-3 px-8 rounded-2xl text-xl transition">å†ç©ä¸€æ¬¡ â™»ï¸</button>
      </div>
    </div>

    <!-- è‡ªè¨‚æ–‡å­— Modal -->
    <div id="custom-words-modal" class="absolute inset-0 items-center justify-center modal hidden z-20">
      <div class="bg-white p-8 rounded-3xl shadow-2xl text-center w-11/12 max-w-lg border-4 border-blue-200">
        <h2 class="title text-2xl font-bold mb-2 text-blue-600">è‡ªè¨‚ç·´ç¿’å…§å®¹</h2>
        <p class="text-slate-600 mb-4">è«‹è¼¸å…¥æƒ³ç·´ç¿’çš„ç”Ÿå­—èªè©ï¼Œæ¯è¡Œä¸€å€‹ã€‚</p>
        <textarea id="custom-words-input" class="w-full h-48 p-3 border-2 border-blue-200 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-blue-300 bg-blue-50" placeholder="ä¾‹å¦‚ï¼š&#10;è˜‹æœ&#10;banana&#10;æŒä¹‹ä»¥æ†"></textarea>
        <div class="flex justify-end gap-3">
          <button id="cancel-custom-words-button" class="px-5 py-2 rounded-xl border-2 border-slate-300 text-slate-600 bg-white hover:bg-slate-50">å–æ¶ˆ</button>
          <button id="save-custom-words-button" class="btn-lemon jelly text-amber-900 font-bold py-2 px-5 rounded-xl">å„²å­˜ä¸¦é–‹å§‹ ğŸ‹</button>
        </div>
      </div>
    </div>

    <!-- ç¢ºèªä¸­æ­¢ Modal -->
    <div id="confirm-modal" class="absolute inset-0 hidden items-center justify-center modal z-30">
      <div class="bg-white p-6 rounded-2xl shadow-xl text-center w-11/12 max-w-sm border-4 border-yellow-200">
        <p id="confirm-text" class="text-slate-700 mb-4">ç¢ºå®šè¦ä¸­æ­¢æŒ‘æˆ°ä¸¦è¿”å›ä¸Šä¸€é å—ï¼Ÿ</p>
        <div class="flex justify-center gap-3">
          <button id="confirm-yes" class="btn-lemon jelly px-5 py-2 rounded-xl border-2 border-yellow-300">æ˜¯çš„ï¼Œå–æ¶ˆä¸¦è¿”å›</button>
          <button id="confirm-no" class="px-5 py-2 rounded-xl border-2 border-slate-300 text-slate-600 bg-white hover:bg-slate-50">å…ˆä¸è¦</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // UI Elements
    const levelEl = document.getElementById('level');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const crashesEl = document.getElementById('crashes');
    const textInput = document.getElementById('text-input');
    const startModal = document.getElementById('start-modal');
    const gameOverModal = document.getElementById('game-over-modal');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const finalScoreEl = document.getElementById('final-score');
    const levelSelect = document.getElementById('level-select');
    const droneSpeedSlider = document.getElementById('drone-speed');
    const spawnRateSlider = document.getElementById('spawn-rate');
    const droneSpeedValueEl = document.getElementById('drone-speed-value');
    const spawnRateValueEl = document.getElementById('spawn-rate-value');
    const customWordsModal = document.getElementById('custom-words-modal');
    const customWordsInput = document.getElementById('custom-words-input');
    const saveCustomWordsButton = document.getElementById('save-custom-words-button');
    const cancelCustomWordsButton = document.getElementById('cancel-custom-words-button');
    const abortButton = document.getElementById('abort-button');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmText = document.getElementById('confirm-text');
    const confirmYes = document.getElementById('confirm-yes');
    const confirmNo = document.getElementById('confirm-no');

    let gameLoopId, timerId, droneSpawnerId;

    // Sound Effects
    let missileSound, explosionSound, gameOverSound, crashExplosionSound;

    // é è¨­ 3 åˆ†é˜ï¼›ä¹‹å¾Œæœƒä¾é¸é …è¦†å¯«
    const DEFAULT_DURATION = 180;

    let gameState = {
      score: 0,
      timeLeft: DEFAULT_DURATION,
      durationSec: DEFAULT_DURATION,
      crashes: 0,
      maxCrashes: 3,
      level: 1,
      droneSpeed: 0.5,
      spawnRate: 3000, // in ms
      active: false,
    };

    let clouds = [];
    let drones = [];
    let missiles = [];
    let explosions = [];
    let confetti = [];
    let dartTrails = [];

    // ä¸Ÿé¢å‹•ç•«ç‹€æ…‹
    let throwAnim = { active: false, p: 0 }; // p: 0â†’1 é€²åº¦

    // é—œå¡è¨­å®š
    const levels = {
      1: ['å¤©','åœ°','äºº','ä½ ','æˆ‘','ä»–','å±±','æ°´','ç«','æœ¨','é‡‘','æ—¥','æœˆ','æ˜Ÿ','é¢¨','é›¨','é›·','é›»','ä¸Š','ä¸‹','å·¦','å³','å‰','å¾Œ','æ±','è¥¿','å—','åŒ—','ä¸­','ç™¼'],
      2: ['ä½ å¥½','è¬è¬','å°ç£','å°åŒ—','é›»è…¦','æ‰‹æ©Ÿ','éŠæˆ²','å­¸ç¿’','ç¨‹å¼','æœªä¾†','å¿«æ¨‚','æˆåŠŸ','å¤©æ°£','åƒé£¯','æœ‹å‹','å­¸æ ¡','è€å¸«','åŒå­¸','é‹å‹•','å¥åº·','éŸ³æ¨‚','é›»å½±','æ—…éŠ','ç¾é£Ÿ','å®¶äºº','å¯µç‰©','å¸Œæœ›','å¤¢æƒ³','åŠªåŠ›','åŠ æ²¹'],
      3: ['æ²’å•é¡Œ','ç‚ºä»€éº¼','æ€éº¼è¾¦','ä½ å¥½å—','æˆ‘æ„›ä½ ','çœŸçš„å—','å¤ªå¥½äº†','ä¸å®¢æ°£','å°ä¸èµ·','æ²’é—œä¿‚','è¾›è‹¦äº†','é€›å¤œå¸‚','çœ‹é›»å½±','å–çå¥¶','å¯«ä½œæ¥­','æ‰“ç±ƒçƒ','è½éŸ³æ¨‚','å»æ—…è¡Œ','åƒæ—©é¤','ç¡åˆè¦º','ä¸Šç¶²è·¯','ç©éŠæˆ²','äº¤æœ‹å‹','å­¸ä¸­æ–‡','å¾ˆé–‹å¿ƒ','ä¸çŸ¥é“','ç­‰ä¸€ä¸‹','æ­¡è¿ä½ ','ç¥ä½ å¥½é‹','ä¸€è·¯é †é¢¨'],
      4: ['ä¸€è¦‹é¾æƒ…','å¿ƒæƒ³äº‹æˆ','è¬äº‹å¦‚æ„','å¹³æ­¥é’é›²','ç™¾èŠ±é½Šæ”¾','åƒè®Šè¬åŒ–','ç•«é¾é»ç›','è»Šæ°´é¦¬é¾','é¢¨å’Œæ—¥éº—','é³¥èªèŠ±é¦™','ä¸€å¿ƒä¸€æ„','ä¸‰å¿ƒäºŒæ„','äº”èŠ±å…«é–€','ä¸ƒä¸Šå…«ä¸‹','ä¹ç‰›ä¸€æ¯›','åå…¨åç¾','è‡ªç”±è‡ªåœ¨','ç„¡æ†‚ç„¡æ…®','å¤§é–‹çœ¼ç•Œ','å¾—å¿ƒæ‡‰æ‰‹','é£²æ°´æ€æº','å®ˆæ ªå¾…å…”','äº¡ç¾Šè£œç‰¢','äº•åº•ä¹‹è›™','ç‹å‡è™å¨','ç•«è›‡æ·»è¶³','é©šå¼“ä¹‹é³¥','å°ç‰›å½ˆç´','æ©è€³ç›œéˆ´','è‡ªç›¸çŸ›ç›¾'],
      5: ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],
      6: ['run','sun','cat','dog','pen','box','key','cup','hat','map','bus','car','fly','sky','try','egg','jam','ice','fan','bed','leg','arm','lip','eye','ear','ant','bee','cow','fox','pig'],
      7: ['apple','banana','orange','grape','lemon','melon','peach','water','earth','happy','smile','dream','music','style','power','magic','light','sound','color','shape','space','cloud','green','white','black','brown','friend','family','school','world'],
      8: ['computer','keyboard','internet','program','language','challenge','success','beautiful','wonderful','important','technology','information','adventure','experience','knowledge','education','development','environment','celebration','imagination'],
      9: [],
      10: []
    };
    levels[9] = [...levels[1], ...levels[2], ...levels[3], ...levels[4], ...levels[6], ...levels[7], ...levels[8]];

    const levelDisplayNames = { 9: 'éš¨æ©Ÿ', 10: 'è‡ªè¨‚' };

    function resizeCanvas() { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
    window.addEventListener('resize', resizeCanvas);

    // === å¯æ„›èƒŒæ™¯é›² ===
    function initClouds() {
      clouds = Array.from({ length: 6 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height * 0.6,
        r: 18 + Math.random() * 22,
        vx: 0.2 + Math.random() * 0.4,
        a: 0.2 + Math.random() * 0.2,
      }));
    }
    function drawCuteClouds() {
      clouds.forEach(c => {
        c.x += c.vx; if (c.x - c.r * 3 > canvas.width) c.x = -c.r * 3;
        ctx.save(); ctx.globalAlpha = c.a; ctx.fillStyle = '#ffffff';
        ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.arc(c.x + c.r, c.y + 6, c.r * 0.9, 0, Math.PI * 2);
        ctx.arc(c.x - c.r * 0.8, c.y + 8, c.r * 0.8, 0, Math.PI * 2);
        ctx.fill(); ctx.restore();
      });
    }

    // === ç¹ªåœ–ï¼šå°é›²å¯¶ï¼ˆç„¡äººæ©Ÿï¼‰ ===
    function drawDrones() {
      drones.forEach(drone => {
        ctx.save(); ctx.translate(drone.x, drone.y);
        const R = 22; ctx.fillStyle = '#fff'; ctx.strokeStyle = '#fcd34d'; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, 0, R, 0, Math.PI * 2);
        ctx.arc(-R * 0.7, 4, R * 0.7, 0, Math.PI * 2);
        ctx.arc(R * 0.8, 5, R * 0.8, 0, Math.PI * 2);
        ctx.fill(); ctx.stroke();

        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillStyle = '#111827';
        ctx.beginPath(); ctx.arc(-8, -2, 2.5, 0, Math.PI * 2); ctx.arc(8, -2, 2.5, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = 'rgba(255, 159, 171, .8)'; ctx.beginPath(); ctx.arc(-12, 4, 3.2, 0, Math.PI * 2); ctx.arc(12, 4, 3.2, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 1.8; ctx.beginPath(); ctx.arc(0, 2, 3, 0, Math.PI, false); ctx.stroke();

        ctx.fillStyle = '#1f2937'; ctx.font = '700 16px "Noto Sans TC"'; ctx.fillText(drone.text, 0, -R - 14);

        if (drone.isTargeted) {
          const t = Date.now() / 180; const pulse = 0.6 + Math.sin(t) * 0.4;
          ctx.strokeStyle = `rgba(244, 63, 94, ${0.7 * pulse})`; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(0, 0, R + 6, 0, Math.PI * 2); ctx.stroke();
        }
        ctx.restore();
      });
    }

    // === é£›é¢ï¼ˆå«æ‹–å°¾ï¼‰ ===
    function drawMissiles() {
      missiles.forEach(missile => {
        ctx.save(); ctx.translate(missile.x, missile.y);
        if (missile.target) { const dx = missile.target.x - missile.x; const dy = missile.target.y - missile.y; ctx.rotate(Math.atan2(dy, dx)); }
        drawDartShape(0, 0, 1.2);
        ctx.restore();
      });
    }
    function drawTrails() {
      dartTrails.forEach(p => {
        ctx.globalAlpha = p.a; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1;
      });
    }

    // === å¯æ„›çˆ†ç‚¸ï¼ˆæ„›å¿ƒ/ç³–ç²‰ï¼‰ ===
    function drawExplosions() {
      explosions.forEach(explosion => {
        ctx.save(); ctx.globalAlpha = explosion.alpha; ctx.translate(explosion.x, explosion.y);
        heartPath(0, 0, explosion.radius); ctx.fillStyle = 'rgba(255, 99, 132, .65)'; ctx.fill();
        ctx.restore();
      });
      confetti.forEach((p) => { ctx.globalAlpha = p.a; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; });
    }
    function heartPath(x, y, s) {
      ctx.beginPath(); ctx.moveTo(x, y);
      ctx.bezierCurveTo(x - s, y - s, x - s * 1.2, y + s * 0.4, x, y + s);
      ctx.bezierCurveTo(x + s * 1.2, y + s * 0.4, x + s, y - s, x, y);
      ctx.closePath();
    }

    // === è§’è‰²ï¼ˆä¸Ÿé¢å‹•ç•«ï¼‰ ===
    function drawThrower() {
      const x = canvas.width / 2, y = canvas.height; // è§’è‰²åº•éƒ¨ä¸­å¤®
      ctx.save(); ctx.translate(x, y);
      // é ­
      ctx.fillStyle = '#fde68a'; ctx.beginPath(); ctx.arc(0, -42, 16, 0, Math.PI * 2); ctx.fill();
      // è‡‰
      ctx.fillStyle = '#111827'; ctx.beginPath(); ctx.arc(-5, -45, 2, 0, Math.PI * 2); ctx.arc(5, -45, 2, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 1.6; ctx.beginPath(); ctx.arc(0, -40, 3, 0, Math.PI, false); ctx.stroke();
      // èº«é«”
      ctx.fillStyle = '#fca5a5'; ctx.fillRect(-8, -28, 16, 20);
      // æ‰‹è‡‚è§’åº¦ï¼ˆä¸Ÿå‡ºâ†’æ”¶å›ï¼‰
      const swing = Math.sin(throwAnim.p * Math.PI) * 0.9; // 0â†’1â†’0
      const armAngle = -0.6 - swing; // åŸºç¤æŠ¬æ‰‹ -0.6ï¼Œå†å¾€ä¸Šæ®
      ctx.save(); ctx.translate(8, -18); ctx.rotate(armAngle);
      ctx.fillRect(0, 0, 14, 5);
      ctx.translate(14, 2.5); drawDartShape(0, 0, 1);
      ctx.restore();
      // è…¿
      ctx.fillStyle = '#60a5fa'; ctx.fillRect(-10, -8, 8, 10); ctx.fillRect(2, -8, 8, 10);
      ctx.restore();
    }

    function drawDartShape(cx, cy, scale = 1) {
      ctx.save(); ctx.translate(cx, cy); ctx.scale(scale, scale);
      ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(10, -3); ctx.lineTo(10, 3); ctx.closePath(); ctx.fill();
      ctx.fillStyle = '#374151'; ctx.fillRect(0, -1.2, 10, 2.4);
      ctx.fillStyle = '#60a5fa'; ctx.beginPath(); ctx.moveTo(-4, -3); ctx.lineTo(0, -1); ctx.lineTo(0, 1); ctx.lineTo(-4, 3); ctx.closePath(); ctx.fill();
      ctx.restore();
    }

    function updateThrowerAnim() {
      if (!throwAnim.active) return; throwAnim.p += 0.15; if (throwAnim.p >= 1) { throwAnim.active = false; throwAnim.p = 0; }
    }

    // === æ›´æ–° ===
    function updateDrones() {
      drones.forEach((drone, index) => {
        drone.y += gameState.droneSpeed; drone.propellerAngle += 0.5;
        if (drone.y > canvas.height) {
          drones.splice(index, 1); gameState.crashes++; updateUI(); createExplosion(drone.x, canvas.height, true);
          if (crashExplosionSound) { crashExplosionSound.triggerAttackRelease('0.8', Tone.now()); }
          if (gameState.crashes >= gameState.maxCrashes) endGame();
        }
      });
    }

    function updateMissiles() {
      missiles.forEach((missile, index) => {
        const target = missile.target; const dx = target.x - missile.x; const dy = target.y - missile.y; const dist = Math.hypot(dx, dy);
        if (dist < 10 || !drones.includes(target)) {
          createExplosion(target.x, target.y);
          if (drones.includes(target)) {
            explosionSound.triggerAttackRelease('0.3', Tone.now());
            gameState.score += target.text.length * 10; updateUI();
            drones = drones.filter(d => d !== target);
            sprinkleConfetti(target.x, target.y);
          }
          missiles.splice(index, 1);
        } else {
          // ç”¢ç”Ÿæ‹–å°¾ç²’å­ï¼ˆæ²¿åæ–¹å‘æ•£é–‹ï¼‰
          const ux = dx / dist, uy = dy / dist;
          dartTrails.push({ x: missile.x, y: missile.y, vx: -ux * (0.5 + Math.random()), vy: -uy * (0.5 + Math.random()), r: 2 + Math.random() * 2, a: 0.8, c: ['#fda4af','#fdba74','#93c5fd'][Math.floor(Math.random()*3)] });
          missile.x += ux * 8; missile.y += uy * 8;
        }
      });
    }

    function updateTrails() {
      dartTrails.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.a -= 0.03; p.r *= 0.985; if (p.a <= 0.02) dartTrails.splice(i, 1); });
    }

    function updateExplosions() {
      explosions.forEach((e, i) => { e.radius += 1.4; e.alpha -= 0.025; if (e.alpha <= 0) explosions.splice(i, 1); });
      confetti.forEach((p, i) => { p.y += p.vy; p.x += p.vx; p.a -= 0.02; if (p.a <= 0) confetti.splice(i, 1); });
    }

    function spawnDrone() {
      const list = levels[gameState.level]; if (!list || list.length === 0) return;
      const text = list[Math.floor(Math.random() * list.length)];
      const tw = 40;
      drones.push({ text, x: Math.random() * (canvas.width - tw - 20) + tw / 2 + 10, y: -34, isTargeted: false, propellerAngle: 0 });
    }

    function createExplosion(x, y, isCrash = false) { explosions.push({ x, y, radius: isCrash ? 12 : 8, alpha: 1 }); }

    function sprinkleConfetti(x, y) { for (let i = 0; i < 14; i++) { confetti.push({ x, y, r: 2 + Math.random() * 3, vx: (Math.random() - 0.5) * 2, vy: -1 - Math.random() * 2, a: 0.9, c: ['#fda4af','#fdba74','#fef08a','#86efac','#93c5fd'][Math.floor(Math.random()*5)] }); } }

    // ---- é€šç”¨ç¢ºèªæ¡†ï¼ˆé¿å…ç€è¦½å™¨å°é– window.confirmï¼‰ ----
    function uiConfirm(message, onYes) {
      if (!confirmModal) { onYes(); return; }
      confirmText.textContent = message || 'ç¢ºå®šå—ï¼Ÿ';
      confirmModal.classList.remove('hidden');
      confirmModal.classList.add('flex');
      const cleanup = () => {
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
        confirmYes.removeEventListener('click', onYesWrapped);
        confirmNo.removeEventListener('click', cleanup);
      };
      const onYesWrapped = () => { cleanup(); onYes(); };
      confirmYes.addEventListener('click', onYesWrapped);
      confirmNo.addEventListener('click', cleanup);
    }

    // === éŠæˆ²è¿´åœˆ ===
    function gameLoop() {
      if (!gameState.active) return; ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawCuteClouds();
      updateThrowerAnim(); updateDrones(); updateMissiles(); updateTrails(); updateExplosions();
      drawThrower(); drawDrones(); drawTrails(); drawMissiles(); drawExplosions();
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    // === éŸ³æ•ˆ ===
    function setupSounds() {
      missileSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
      explosionSound = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.3, sustain: 0 } }).toDestination();
      crashExplosionSound = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.05, decay: 0.8, sustain: 0.1 } }).toDestination();
      crashExplosionSound.volume.value = 3; gameOverSound = new Tone.Synth().toDestination();
    }

    function getSelectedDuration() {
      const el = document.querySelector('input[name="duration"]:checked');
      const val = el ? parseInt(el.value, 10) : DEFAULT_DURATION;
      return ([60, 120, 180].includes(val)) ? val : DEFAULT_DURATION;
    }

    function init() {
      resizeCanvas(); initClouds(); updateSettingsUI();
      startButton.addEventListener('click', async () => { await Tone.start(); setupSounds(); if (levelSelect.value === '10') { startModal.classList.add('hidden'); startModal.classList.remove('flex'); customWordsModal.classList.remove('hidden'); customWordsModal.classList.add('flex'); customWordsInput.focus(); } else { startGame(); } });
      restartButton.addEventListener('click', () => { gameOverModal.classList.add('hidden'); gameOverModal.classList.remove('flex'); startModal.classList.remove('hidden'); startModal.classList.add('flex'); });
      textInput.addEventListener('keydown', handleInput);
      saveCustomWordsButton.addEventListener('click', () => { const words = customWordsInput.value.trim().split('\n').map(w => w.trim()).filter(w => w.length > 0); if (words.length === 0) { customWordsInput.value = ''; customWordsInput.placeholder = 'è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹è©ï¼'; return; } levels[10] = words; customWordsModal.classList.add('hidden'); customWordsModal.classList.remove('flex'); startGame(); });
      cancelCustomWordsButton.addEventListener('click', () => { customWordsModal.classList.add('hidden'); customWordsModal.classList.remove('flex'); startModal.classList.remove('hidden'); startModal.classList.add('flex'); });
      abortButton.addEventListener('click', abortAndBack);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && gameState.active) abortAndBack(); });
      droneSpeedSlider.addEventListener('input', (e) => { droneSpeedValueEl.textContent = parseFloat(e.target.value).toFixed(1); });
      spawnRateSlider.addEventListener('input', (e) => { spawnRateValueEl.textContent = (6 - parseFloat(e.target.value)).toFixed(1); });
      runSelfTests();
    }

    function startGame() {
      // å…ˆä¾é¸æ“‡è¨­å®šæŒ‘æˆ°æ™‚é–“
      gameState.durationSec = getSelectedDuration();
      resetGameState();
      gameState.level = parseInt(levelSelect.value, 10);
      gameState.droneSpeed = parseFloat(droneSpeedSlider.value);
      gameState.spawnRate = (6 - parseFloat(spawnRateSlider.value)) * 1000;
      initClouds(); gameState.active = true; updateUI();
      startModal.classList.add('hidden'); startModal.classList.remove('flex');
      textInput.disabled = false; textInput.focus();
      timerId = setInterval(updateTimer, 1000); droneSpawnerId = setInterval(spawnDrone, gameState.spawnRate);
      gameLoop();
    }

    function endGame() {
      gameState.active = false; clearInterval(timerId); clearInterval(droneSpawnerId); cancelAnimationFrame(gameLoopId);
      const now = Tone.now(); gameOverSound.triggerAttackRelease('C4', '8n', now); gameOverSound.triggerAttackRelease('G3', '8n', now + 0.2); gameOverSound.triggerAttackRelease('E3', '4n', now + 0.4);
      textInput.disabled = true; textInput.value = '';
      finalScoreEl.textContent = gameState.score; gameOverModal.classList.remove('hidden'); gameOverModal.classList.add('flex');
    }

    // ä¸­æ­¢ï¼ˆä¸è§¸ç™¼éŠæˆ²çµæŸè¦–çª—ï¼‰
    function stopGameSilently() { gameState.active = false; clearInterval(timerId); clearInterval(droneSpawnerId); cancelAnimationFrame(gameLoopId); textInput.disabled = true; textInput.value = ''; }

    // é‡ç½®ç‹€æ…‹ï¼ˆç”¨æ–¼ä¸­æ­¢è¿”å› & é–‹å§‹æ–°éŠæˆ²å‰ï¼‰
    function resetGameState() {
      gameState.score = 0; gameState.timeLeft = gameState.durationSec; gameState.crashes = 0;
      missiles = []; explosions = []; confetti = []; dartTrails = []; drones = [];
      throwAnim = { active: false, p: 0 };
      updateUI();
    }

    function goBackOrHome() {
      // å…ˆå›åˆ°é–‹å§‹ç•«é¢ï¼Œç¢ºä¿ä½¿ç”¨è€…çœ‹åˆ°æ˜ç¢ºå›é¥‹
      startModal.classList.remove('hidden');
      startModal.classList.add('flex');
      gameOverModal.classList.add('hidden');
      gameOverModal.classList.remove('flex');
      // å†å˜—è©¦å›ä¸Šä¸€é ï¼ˆè‹¥åœ¨å¯å°èˆªç’°å¢ƒï¼‰
      try {
        if (document.referrer && document.referrer !== location.href) {
          setTimeout(() => window.history.back(), 120);
        }
      } catch(_) { /* å¿½ç•¥ */ }
    }

    function abortAndBack() {
      const doAbort = () => { stopGameSilently(); resetGameState(); goBackOrHome(); };
      // ä½¿ç”¨è‡ªè¨‚ç¢ºèªæ¡†ï¼Œé¿å…æŸäº›ç’°å¢ƒä¸‹ window.confirm æ²’åæ‡‰
      uiConfirm('ç¢ºå®šè¦ä¸­æ­¢æŒ‘æˆ°ä¸¦è¿”å›ä¸Šä¸€é å—ï¼Ÿ', doAbort);
    }

    function updateUI() { levelEl.textContent = levelDisplayNames[gameState.level] || gameState.level; scoreEl.textContent = gameState.score; crashesEl.textContent = `${gameState.crashes} / ${gameState.maxCrashes}`; const m = Math.floor(gameState.timeLeft / 60), s = gameState.timeLeft % 60; timerEl.textContent = `${m}:${s.toString().padStart(2, '0')}`; }
    function updateSettingsUI() { droneSpeedValueEl.textContent = parseFloat(droneSpeedSlider.value).toFixed(1); spawnRateValueEl.textContent = (6 - parseFloat(spawnRateSlider.value)).toFixed(1); }
    function updateTimer() { gameState.timeLeft--; updateUI(); if (gameState.timeLeft <= 0) endGame(); }

    function handleInput(e) {
      if (e.key === 'Enter' && textInput.value.trim() !== '') {
        const inputText = textInput.value.trim();
        const targetDrone = drones.slice().reverse().find(d => d.text.toLowerCase() === inputText.toLowerCase() && !d.isTargeted);
        if (targetDrone) {
          targetDrone.isTargeted = true; missiles.push({ x: canvas.width / 2, y: canvas.height - 40, target: targetDrone });
          // ä¸Ÿé¢å‹•ç•«å•Ÿå‹•
          throwAnim.active = true; throwAnim.p = 0;
          const now = Tone.now(); missileSound.triggerAttack('C5', now); missileSound.frequency.rampTo('G5', 0.2, now); missileSound.triggerRelease(now + 0.2);
        }
        textInput.value = '';
      }
    }

    // â€”â€” è‡ªå‹•æ¸¬è©¦ â€”â€”
    function runSelfTests() {
      try {
        console.group('%cPuti-AI Self Tests','color:#2563eb');
        // å­˜åœ¨æ€§æ¸¬è©¦
        console.assert(typeof drawThrower === 'function', 'drawThrower å­˜åœ¨');
        console.assert(typeof drawMissiles === 'function', 'drawMissiles å­˜åœ¨');
        console.assert(typeof abortAndBack === 'function', 'abortAndBack å­˜åœ¨');
        console.assert(typeof goBackOrHome === 'function', 'goBackOrHome å­˜åœ¨');
        console.assert(typeof uiConfirm === 'function', 'uiConfirm å­˜åœ¨');
        console.assert(typeof getSelectedDuration === 'function', 'getSelectedDuration å­˜åœ¨');
        console.assert(Array.isArray(levels[1]) && levels[1].length > 0, 'levels[1] æœ‰è³‡æ–™');
        console.assert(document.getElementById('abort-button'), '#abort-button å­˜åœ¨');
        console.assert(document.getElementById('start-modal'), '#start-modal å­˜åœ¨');
        console.assert(document.getElementById('confirm-modal'), '#confirm-modal å­˜åœ¨');
        
        // é‡ç½®æ¸¬è©¦ï¼šreset æœƒä½¿ç”¨ gameState.durationSec
        const prevDur = gameState.durationSec;
        gameState.durationSec = 120; // 2 åˆ†é˜
        gameState.score = 999; gameState.timeLeft = 42; gameState.crashes = 2; missiles.push({x:0,y:0});
        resetGameState();
        console.assert(gameState.timeLeft === 120, 'resetGameState ä¾æ“š durationSec é‡ç½®æ™‚é–“');
        console.assert(gameState.score === 0 && gameState.crashes === 0, 'resetGameState é‡ç½®åˆ†æ•¸èˆ‡å¢œæ¯€');
        console.assert(missiles.length === 0 && explosions.length === 0 && drones.length === 0, 'resetGameState æ¸…ç©ºé™£åˆ—');
        gameState.durationSec = prevDur;

        // getSelectedDuration æ¸¬è©¦
        const d60 = document.querySelector('input[name="duration"][value="60"]');
        const d120 = document.querySelector('input[name="duration"][value="120"]');
        const d180 = document.querySelector('input[name="duration"][value="180"]');
        if (d60 && d120 && d180) {
          d60.checked = true; console.assert(getSelectedDuration() === 60, 'getSelectedDuration 60');
          d120.checked = true; console.assert(getSelectedDuration() === 120, 'getSelectedDuration 120');
          d180.checked = true; console.assert(getSelectedDuration() === 180, 'getSelectedDuration 180 (é è¨­)');
        }

        // å‹•ç•«æ¸¬è©¦ï¼ˆä¸é€²å…¥éŠæˆ²è¿´åœˆï¼‰
        throwAnim.active = true; throwAnim.p = 0; for (let i=0;i<8;i++) updateThrowerAnim(); console.assert(throwAnim.p > 0, 'updateThrowerAnim é‹ä½œ');
        console.log('Self tests OK');
      } catch (e) { console.error('Self tests failed:', e); }
      finally { console.groupEnd(); }
    }

    init();
  </script>
</body>
</html>
